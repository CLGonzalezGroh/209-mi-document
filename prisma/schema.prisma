// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client"
    output   = "../src/generated/prisma"
}

datasource db {
    provider = "mysql"
}

// ================================
// ENUMS DEL MÓDULO DE DOCUMENTOS
// ================================

enum ModuleType {
    QUALITY
    PROJECTS
    TAGS
    OPERATIONS
    MANAGEMENT
    COMERCIAL
}

enum RevisionScheme {
    ALPHABETICAL // A, B, C, ..., Z, AA, AB, ...
    NUMERIC // 0, 1, 2, 3, ...
}

enum RevisionStatus {
    DRAFT // En borrador, se pueden subir nuevas versiones
    IN_REVIEW // Enviado a workflow de revisión
    APPROVED // Aprobado, no se puede modificar
    SUPERSEDED // Reemplazado por una nueva revisión
    OBSOLETE // Obsoleto, ya no aplica
}

enum WorkflowStatus {
    PENDING // Creado pero no iniciado
    IN_PROGRESS // Al menos un step en proceso
    COMPLETED // Todos los steps aprobados
    REJECTED // Al menos un step rechazado
}

enum StepType {
    REVIEW // Revisión técnica
    APPROVE // Aprobación formal
    ACKNOWLEDGE // Toma de conocimiento
}

enum StepStatus {
    PENDING // No evaluado aún
    APPROVED // Aprobado por el asignado
    REJECTED // Rechazado por el asignado
    SKIPPED // Saltado (ej: aprobador anterior ya rechazó)
}

enum TransmittalStatus {
    DRAFT // En preparación
    ISSUED // Enviado al cliente
    ACKNOWLEDGED // Cliente acusó recibo
    RESPONDED // Cliente respondió con comentarios
    CLOSED // Cerrado
}

enum PurposeCode {
    FOR_APPROVAL // Para aprobación del cliente
    FOR_INFORMATION // Solo informativo
    FOR_CONSTRUCTION // Aprobado para construcción
    FOR_REVIEW // Para revisión y comentarios
    AS_BUILT // Documentación as-built
}

enum ClientStatus {
    APPROVED // Aprobado sin comentarios
    APPROVED_WITH_COMMENTS // Aprobado con comentarios
    REJECTED // Rechazado
    REVIEWED_NO_EXCEPTION // Revisado sin objeción
}

enum LogLevel {
    INFO
    WARNING
    ERROR
}

// ================================
// MODELOS
// ================================

// Clases de documento (nivel 1: Especialidad, Categoría, etc.)
model DocumentClass {
    id           Int       @id @default(autoincrement())
    createdAt    DateTime  @default(now())
    updatedAt    DateTime? @updatedAt
    updatedById  Int       @default(1)
    terminatedAt DateTime?
    isSys        Boolean   @default(false)

    name        String // "Ingeniería Civil", "Eléctrica", "Gestión"
    code        String // "CIVIL", "ELEC", "GEST"
    module      ModuleType? // null = disponible para todos los módulos
    description String?
    sortOrder   Int         @default(0)

    // Relaciones
    documentTypes DocumentType[]
    scannedFiles  ScannedFile[]

    @@unique([name, module]) // Único dentro del mismo módulo
    @@unique([code, module]) // Único dentro del mismo módulo
    @@map("document_classes")
}

// Tipos de documento (Procedimiento, Plano, Informe, etc.)
model DocumentType {
    id           Int       @id @default(autoincrement())
    createdAt    DateTime  @default(now())
    updatedAt    DateTime? @updatedAt
    updatedById  Int       @default(1)
    terminatedAt DateTime?
    isSys        Boolean   @default(false)

    name             String // "Procedimiento", "Plano", "Informe"
    code             String // "PROC", "DWG", "RPT"
    module           ModuleType? // null = disponible para todos los módulos
    classId          Int? // null = disponible para todas las clases
    description      String?
    requiresWorkflow Boolean        @default(false)

    // Relaciones
    class        DocumentClass? @relation(fields: [classId], references: [id])
    documents    Document[]
    scannedFiles ScannedFile[]

    @@unique([name, classId, module]) // Único dentro de la misma clase y módulo
    @@unique([code, classId, module]) // Único dentro de la misma clase y módulo
    @@index([classId])
    @@map("document_types")
}

// Documento maestro
model Document {
    id           Int       @id @default(autoincrement())
    createdAt    DateTime  @default(now())
    createdById  Int // Referencia al User del sistema admin
    updatedAt    DateTime? @updatedAt
    updatedById  Int       @default(1)
    terminatedAt DateTime?
    isSys        Boolean   @default(false)

    code           String // Código del documento (ej: "PR-001")
    title          String
    description    String?
    module         ModuleType // Quality, Projects, Tags, etc.
    entityType     String? // "finding", "action", "project"...
    entityId       Int? // ID de la entidad en otro subgraph
    documentTypeId Int
    revisionScheme RevisionScheme @default(ALPHABETICAL) // Esquema de revisión actual

    // Relaciones
    documentType DocumentType       @relation(fields: [documentTypeId], references: [id])
    revisions    DocumentRevision[]

    @@unique([code, module, entityType, entityId]) // Único dentro del mismo contexto (módulo + entidad)
    @@index([module, entityType, entityId])
    @@map("documents")
}

// Revisiones de un documento (A, B, C... o 0, 1, 2...)
model DocumentRevision {
    id          Int       @id @default(autoincrement())
    createdAt   DateTime  @default(now())
    createdById Int // Referencia al User del sistema admin
    updatedAt   DateTime? @updatedAt
    updatedById Int       @default(1)

    documentId   Int
    revisionCode String // "A", "B", "C" o "0", "1", "2"
    status       RevisionStatus @default(DRAFT)
    approvedById Int?
    approvedAt   DateTime?

    // Relaciones
    document         Document          @relation(fields: [documentId], references: [id], onDelete: Cascade)
    versions         DocumentVersion[]
    workflow         ReviewWorkflow?
    transmittalItems TransmittalItem[]

    @@unique([documentId, revisionCode])
    @@map("document_revisions")
}

// Versiones de archivo dentro de una revisión
model DocumentVersion {
    id          Int      @id @default(autoincrement())
    createdAt   DateTime @default(now())
    createdById Int // Referencia al User del sistema admin

    revisionId    Int
    versionNumber Int // 1, 2, 3...
    fileKey       String // Key en DO Spaces
    fileName      String // Nombre original del archivo
    fileSize      Int // Tamaño en bytes
    mimeType      String // "application/pdf", "image/jpeg"
    checksum      String? // SHA-256 para integridad
    comment       String? // "Corrección del conexionado en la página 5"

    // Relaciones
    revision DocumentRevision @relation(fields: [revisionId], references: [id], onDelete: Cascade)

    @@unique([revisionId, versionNumber])
    @@map("document_versions")
}

// Workflow de revisión (ISO 9001)
model ReviewWorkflow {
    id        Int      @id @default(autoincrement())
    createdAt DateTime @default(now())

    revisionId    Int            @unique
    status        WorkflowStatus @default(PENDING)
    initiatedById Int
    initiatedAt   DateTime       @default(now())
    completedAt   DateTime?

    // Relaciones
    revision DocumentRevision @relation(fields: [revisionId], references: [id], onDelete: Cascade)
    steps    ReviewStep[]

    @@map("review_workflows")
}

// Pasos individuales del workflow
model ReviewStep {
    id        Int      @id @default(autoincrement())
    createdAt DateTime @default(now())

    workflowId    Int
    stepOrder     Int // Orden de ejecución
    stepType      StepType // REVIEW, APPROVE, ACKNOWLEDGE
    assignedToId  Int // Referencia al User del sistema admin
    status        StepStatus @default(PENDING)
    comments      String?
    completedAt   DateTime?
    signatureHash String? // Hash para trazabilidad ISO

    // Relaciones
    workflow ReviewWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

    @@unique([workflowId, stepOrder])
    @@map("review_steps")
}

// Transmittals de ingeniería
model Transmittal {
    id          Int       @id @default(autoincrement())
    createdAt   DateTime  @default(now())
    updatedAt   DateTime? @updatedAt
    updatedById Int       @default(1)

    code             String            @unique // "TR-001"
    projectId        Int // Referencia externa al subgraph projects
    status           TransmittalStatus @default(DRAFT)
    issuedTo         String // Nombre del cliente/destinatario
    issuedById       Int // Referencia al User del sistema admin
    issuedAt         DateTime?
    responseAt       DateTime?
    responseComments String?

    // Relaciones
    items TransmittalItem[]

    @@index([projectId])
    @@map("transmittals")
}

// Items de un transmittal
model TransmittalItem {
    id Int @id @default(autoincrement())

    transmittalId      Int
    documentRevisionId Int
    purposeCode        PurposeCode
    clientStatus       ClientStatus?
    clientComments     String?

    // Relaciones
    transmittal      Transmittal      @relation(fields: [transmittalId], references: [id], onDelete: Cascade)
    documentRevision DocumentRevision @relation(fields: [documentRevisionId], references: [id])

    @@unique([transmittalId, documentRevisionId])
    @@map("transmittal_items")
}

// Adjuntos simples (evidencias, fotos, archivos de soporte)
model Attachment {
    id          Int      @id @default(autoincrement())
    createdAt   DateTime @default(now())
    createdById Int
    module      ModuleType
    entityType  String   @db.VarChar(100)
    entityId    Int
    fileKey     String   @db.VarChar(500)
    fileName    String   @db.VarChar(300)
    fileSize    Int
    mimeType    String   @db.VarChar(100)
    description String?  @db.VarChar(500)

    @@index([module, entityType, entityId])
    @@map("attachments")
}

enum DigitalDisposition {
    PENDING // Sin clasificar
    ACCEPTED // Aceptado, pendiente de carga en sistema externo
    UPLOADED // Cargado en sistema externo, ciclo cerrado
    DISCARDED // Descartado, sin valor documental
}

enum PhysicalDisposition {
    PENDING // Sin decisión
    DESTROY // Programado para destrucción
    DESTROYED // Destrucción confirmada
    ARCHIVE // Programado para almacenamiento físico
    ARCHIVED // Almacenamiento confirmado
}

// Archivos digitalizados pendientes de clasificación
model ScannedFile {
    id                  Int                  @id @default(autoincrement())
    createdAt           DateTime             @default(now())
    createdById         Int
    updatedAt           DateTime             @updatedAt
    updatedById         Int                  @default(1)
    projectId           Int
    documentTypeId      Int?
    documentClassId     Int?
    areaId              Int?
    title               String               @db.VarChar(500)
    description         String?              @db.Text
    originalReference   String?              @db.VarChar(255)
    physicalLocation    String?              @db.VarChar(500)
    fileKey             String               @db.VarChar(500)
    fileName            String               @db.VarChar(255)
    fileSize            Int
    mimeType            String               @db.VarChar(100)
    digitalDisposition  DigitalDisposition   @default(PENDING)
    physicalDisposition PhysicalDisposition  @default(PENDING)
    externalReference   String?              @db.VarChar(500)
    discardReason       String?              @db.Text
    classificationNotes String?              @db.Text
    classifiedById      Int?
    classifiedAt        DateTime?
    physicalConfirmedById Int?
    physicalConfirmedAt  DateTime?
    terminatedAt        DateTime?

    documentType  DocumentType?  @relation(fields: [documentTypeId], references: [id])
    documentClass DocumentClass? @relation(fields: [documentClassId], references: [id])
    area          Area?          @relation(fields: [areaId], references: [id])

    @@index([projectId])
    @@index([documentClassId])
    @@index([areaId])
    @@index([digitalDisposition])
    @@index([physicalDisposition])
    @@index([projectId, digitalDisposition])
    @@map("scanned_files")
}

// Áreas físicas o ubicaciones en planta
model Area {
    id           Int       @id @default(autoincrement())
    createdAt    DateTime  @default(now())
    updatedAt    DateTime? @updatedAt
    updatedById  Int       @default(1)
    terminatedAt DateTime?
    isSys        Boolean   @default(false)

    name        String // "01 - Urea", "02 - Amoníaco"
    code        String // "01", "02"
    projectId   Int // Proyecto al que pertenece
    description String?
    sortOrder   Int    @default(0)

    // Relaciones
    scannedFiles ScannedFile[]

    @@unique([code, projectId]) // Único dentro del mismo proyecto
    @@index([projectId])
    @@map("areas")
}

// Logs generales del sistema (operacionales)
model DocumentSysLog {
    id        Int      @id @default(autoincrement())
    createdAt DateTime @default(now())
    userId    Int // Referencia al User del sistema admin
    level     LogLevel
    name      String?  @db.VarChar(200)
    message   String   @db.VarChar(2048)
    meta      String?  @db.Text

    @@index([userId, level, createdAt])
    @@map("document_sys_logs")
}

// Logs del Sistema Archivados
model DocumentSysLogArchive {
    id        Int      @id @default(autoincrement())
    createdAt DateTime
    userId    Int // Referencia al User del sistema admin
    level     LogLevel
    name      String?  @db.VarChar(200)
    message   String   @db.VarChar(2048)
    meta      String?  @db.Text

    @@index([userId, level, createdAt])
    @@map("document_sys_logs_archive")
}
